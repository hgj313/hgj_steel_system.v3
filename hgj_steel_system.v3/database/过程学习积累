// é€‰æ‹©æœ€ä¼˜çš„æ¨¡æ•°é’¢æç»„åˆä»¥æ»¡è¶³å½“å‰éœ€æ±‚
selectBestModule(demand, groupKey, force = false) { // æ–¹æ³•åï¼Œå‚æ•°ï¼šdemandï¼ˆéœ€æ±‚å¯¹è±¡ï¼‰ï¼ŒgroupKeyï¼ˆåˆ†ç»„æ ‡è¯†ï¼‰ï¼Œforceï¼ˆå¸ƒå°”å€¼ï¼Œé»˜è®¤falseï¼‰
  // thisï¼šæŒ‡å‘å½“å‰ç±»çš„å®ä¾‹ï¼ˆå³SteelOptimizerV3å¯¹è±¡ï¼‰ï¼Œç”¨äºè®¿é—®ç±»çš„å±æ€§å’Œæ–¹æ³•
  // getOrCreateModuleSteelPoolï¼šç±»çš„æ–¹æ³•ï¼Œè·å–æˆ–æ–°å»ºä¸€ä¸ªé’¢ææ± å¯¹è±¡
  // poolï¼šå˜é‡ï¼Œå­˜å‚¨å½“å‰åˆ†ç»„ä¸‹çš„æ¨¡æ•°é’¢ææ± å¯¹è±¡
  const pool = this.getOrCreateModuleSteelPool(groupKey);

  // findSingleSteelSolutionï¼šç±»çš„æ–¹æ³•ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰å•æ ¹æ¨¡æ•°é’¢æèƒ½æ»¡è¶³éœ€æ±‚é•¿åº¦
  // demand.lengthï¼šéœ€æ±‚å¯¹è±¡çš„lengthå±æ€§ï¼Œè¡¨ç¤ºæ‰€éœ€çš„é•¿åº¦
  // singleSteelï¼šå˜é‡ï¼Œå­˜å‚¨æŸ¥æ‰¾ç»“æœã€‚å¦‚æœæœ‰å•æ ¹é’¢æèƒ½æ»¡è¶³éœ€æ±‚ï¼Œåˆ™ä¸ºè¯¥é’¢æå¯¹è±¡ï¼Œå¦åˆ™ä¸ºnull
  const singleSteel = this.findSingleSteelSolution(demand.length, pool);

  // ifè¯­å¥ï¼šåˆ¤æ–­singleSteelæ˜¯å¦ä¸ºçœŸï¼ˆå³ä¸æ˜¯null/undefined/falseç­‰ï¼‰
  // å¦‚æœæ‰¾åˆ°äº†å•æ ¹é’¢æï¼Œç›´æ¥è¿”å›è¯¥é’¢æå¯¹è±¡ï¼Œæ–¹æ³•æ‰§è¡Œåˆ°æ­¤ç»“æŸ
  if (singleSteel) return singleSteel;

  // this.constraintsï¼šå½“å‰å¯¹è±¡çš„constraintså±æ€§ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçº¦æŸé…ç½®å¯¹è±¡
  // maxWeldingSegmentsï¼šæœ€å¤§å…è®¸çš„ç„Šæ¥æ®µæ•°ï¼ˆæ•´æ•°ï¼‰
  // ifè¯­å¥ï¼šåˆ¤æ–­æ˜¯å¦å…è®¸ç„Šæ¥ï¼ˆå³æœ€å¤§ç„Šæ¥æ®µæ•°å¤§äº1ï¼‰
  if (this.constraints.maxWeldingSegments > 1) {
    // findMultiSteelSolutionï¼šç±»çš„æ–¹æ³•ï¼ŒæŸ¥æ‰¾å¤šæ ¹é’¢æç»„åˆèƒ½å¦æ»¡è¶³éœ€æ±‚
    // å‚æ•°åˆ†åˆ«ä¸ºéœ€æ±‚é•¿åº¦ã€é’¢ææ± ã€æœ€å¤§ç„Šæ¥æ®µæ•°
    // multiSteelï¼šå˜é‡ï¼Œå­˜å‚¨å¤šæ ¹ç»„åˆçš„æŸ¥æ‰¾ç»“æœ
    const multiSteel = this.findMultiSteelSolution(
      demand.length, // éœ€æ±‚é•¿åº¦ï¼ˆæ•°å­—ç±»å‹ï¼‰
      pool, // å½“å‰é’¢ææ± å¯¹è±¡
      this.constraints.maxWeldingSegments // æœ€å¤§ç„Šæ¥æ®µæ•°ï¼ˆæ•´æ•°ï¼‰
    );
    // å¦‚æœæ‰¾åˆ°äº†å¤šæ ¹ç»„åˆæ–¹æ¡ˆï¼Œè¿”å›è¯¥æ–¹æ¡ˆå¯¹è±¡
    if (multiSteel) return multiSteel;
  }

  // å¦‚æœå•æ ¹å’Œå¤šæ ¹ç»„åˆéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œè¯´æ˜æ˜¯çº¦æŸæœ¬èº«å¯¼è‡´çš„æ— è§£
  // console.errorï¼šåœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜
  // æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆåå¼•å·åŒ…è£¹ï¼Œ${}å†…å¯æ’å…¥å˜é‡ï¼‰
  console.error(
    `âŒ çœŸæ­£çš„çº¦æŸå†²çªï¼šéœ€æ±‚${demand.length}mmåœ¨W=${this.constraints.maxWeldingSegments}çº¦æŸä¸‹æ— æ³•æ»¡è¶³`
  );
  // è¿”å›nullï¼Œè¡¨ç¤ºæ— è§£
  return null;
}

// å°è¯•ç”¨å¤šæ ¹æ¨¡æ•°é’¢æç»„åˆæ»¡è¶³éœ€æ±‚
findMultiSteelSolution(requiredLength, pool, maxSegments) { // æ–¹æ³•åï¼Œå‚æ•°ï¼šrequiredLengthï¼ˆéœ€æ±‚é•¿åº¦ï¼‰ï¼Œpoolï¼ˆé’¢ææ± å¯¹è±¡ï¼‰ï¼ŒmaxSegmentsï¼ˆæœ€å¤§ç„Šæ¥æ®µæ•°ï¼‰
  // pool.availableLengthsï¼šé’¢ææ± å¯¹è±¡çš„availableLengthså±æ€§ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨æ‰€æœ‰å¯ç”¨çš„é’¢æé•¿åº¦ï¼ˆæ•°å­—ï¼‰
  // sort((a, b) => b - a)ï¼šå¯¹æ•°ç»„è¿›è¡Œé™åºæ’åºï¼ˆä»å¤§åˆ°å°ï¼‰ï¼Œä»¥ä¾¿ä¼˜å…ˆå°è¯•è¾ƒé•¿çš„é’¢æ
  // availableLengthsï¼šå˜é‡ï¼Œå­˜å‚¨æ’åºåçš„é•¿åº¦æ•°ç»„
  const availableLengths = pool.availableLengths.sort((a, b) => b - a);

  // forå¾ªç¯ï¼šsegmentsä»2å¼€å§‹ï¼Œé€’å¢åˆ°maxSegmentsï¼ˆåŒ…å«maxSegmentsï¼‰
  // ä¾æ¬¡å°è¯•ç”¨2æ®µã€3æ®µã€...ã€maxSegmentsæ®µé’¢æç»„åˆæ¥æ»¡è¶³éœ€æ±‚
  for (let segments = 2; segments <= maxSegments; segments++) {
    // findOptimalCombinationï¼šç±»çš„æ–¹æ³•ï¼Œç”¨äºæŸ¥æ‰¾åœ¨æŒ‡å®šæ®µæ•°ä¸‹ï¼Œèƒ½å¦ç”¨availableLengthsæ•°ç»„ä¸­çš„é’¢æç»„åˆå‡ºrequiredLength
    // combinationï¼šå˜é‡ï¼Œå­˜å‚¨æŸ¥æ‰¾ç»“æœã€‚å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„ç»„åˆï¼Œåˆ™ä¸ºç»„åˆå¯¹è±¡ï¼Œå¦åˆ™ä¸ºnull
    const combination = this.findOptimalCombination(
      requiredLength, // éœ€æ±‚æ€»é•¿åº¦
      availableLengths, // å¯ç”¨é•¿åº¦æ•°ç»„
      segments // å½“å‰å°è¯•çš„æ®µæ•°
    );
    // å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„ç»„åˆ
    if (combination) {
      // createMultiSegmentSteelï¼šç±»çš„æ–¹æ³•ï¼Œç”¨äºæ ¹æ®ç»„åˆç»“æœç”Ÿæˆå¤šæ®µç»„åˆé’¢æå¯¹è±¡
      // è¿”å›è¯¥å¯¹è±¡ï¼Œæ–¹æ³•æ‰§è¡Œåˆ°æ­¤ç»“æŸ
      return this.createMultiSegmentSteel(combination, pool);
    }
  }

  // å¦‚æœæ‰€æœ‰æ®µæ•°éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œè¿”å›null
  return null;
}



// core/remainder/RemainderManager.js

class RemainderManager {
  constructor(wasteThreshold = null) {
    // this: æŒ‡å‘å½“å‰è¢«åˆ›å»ºçš„ RemainderManager å®ä¾‹å¯¹è±¡ã€‚
    // wasteThreshold: åºŸæ–™é˜ˆå€¼ã€‚ä»»ä½•é•¿åº¦å°äºè¿™ä¸ªå€¼çš„é’¢æç‰‡æ®µéƒ½ä¼šè¢«è®¤ä¸ºæ˜¯åºŸæ–™ã€‚
    // ??: ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦ã€‚å¦‚æœ wasteThreshold æ˜¯ null æˆ– undefinedï¼Œåˆ™ä½¿ç”¨åé¢çš„é»˜è®¤å€¼ã€‚
    // constraintManager.getWasteThreshold(): ä»å…¨å±€çº¦æŸé…ç½®ä¸­å¿ƒè·å–é»˜è®¤çš„åºŸæ–™é˜ˆå€¼ï¼Œæ¶ˆé™¤äº†ç¡¬ç¼–ç ã€‚
    this.wasteThreshold = wasteThreshold ?? constraintManager.getWasteThreshold();

    // this.remainderPools: ä¸€ä¸ªå¯¹è±¡ï¼ˆå­—å…¸ï¼‰ï¼Œç”¨äºå­˜æ”¾ã€æ‰€æœ‰å¯ç”¨ã€‘çš„ä½™æ–™ã€‚
    // å®ƒçš„é”®(key)æ˜¯è§„æ ¼ç»„åˆé”®(groupKey)ï¼Œå€¼(value)æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œå­˜æ”¾çš„æ˜¯è¯¥è§„æ ¼ä¸‹æ‰€æœ‰ã€å¾…å®šã€‘æˆ–ã€çœŸã€‘ä½™æ–™å¯¹è±¡ã€‚
    // è¿™ä¸ªæ± å­æ˜¯â€œå¹²å‡€â€çš„ï¼Œç»ä¸å…è®¸åºŸæ–™è¿›å…¥ã€‚
    this.remainderPools = {}; 

    // this.wasteBin: ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸€ä¸ªå¯¹è±¡ï¼ˆå­—å…¸ï¼‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„â€œåºŸæ–™ä»“â€ã€‚
    // å®ƒçš„ç»“æ„å’Œ remainderPools å®Œå…¨ä¸€æ ·ï¼Œä½†ç”¨é€”ç›¸åï¼šä¸“é—¨ç”¨äºå­˜æ”¾ã€æ‰€æœ‰è¢«åˆ¤å®šä¸ºåºŸæ–™ã€‘çš„ä½™æ–™å¯¹è±¡ã€‚
    // é€šè¿‡è¿™ä¸ªè®¾è®¡ï¼Œæˆ‘ä»¬å°†â€œå¯ç”¨â€å’Œâ€œåºŸæ–™â€åœ¨ç‰©ç†å­˜å‚¨ä¸Šå½»åº•åˆ†ç¦»ã€‚
    this.wasteBin = {};

    // this.usageHistory: è®°å½•ä½™æ–™è¢«ä½¿ç”¨çš„å†å²ï¼Œç”¨äºè¿½æº¯å’Œè°ƒè¯•ã€‚
    this.usageHistory = {};

    // this.remainderCounters: ä½™æ–™ç¼–å·çš„è®¡æ•°å™¨ï¼Œç¡®ä¿ç”Ÿæˆçš„ä½™æ–™IDæ˜¯å”¯ä¸€çš„ã€‚
    this.remainderCounters = {};
    
    console.log(`ğŸ“‹ ä½™æ–™ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼ŒåºŸæ–™é˜ˆå€¼: ${this.wasteThreshold}mm`);
  }

  initializePool(groupKey) {
    // groupKey: ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä»£è¡¨é’¢æçš„å”¯ä¸€è§„æ ¼ï¼Œä¾‹å¦‚ 'Q345B_200'ã€‚
    // !this.remainderPools[groupKey]: æ£€æŸ¥è¿™ä¸ªè§„æ ¼çš„ä½™æ–™æ± æ˜¯å¦å·²ç»å­˜åœ¨ã€‚
    // å¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡å¤„ç†è¿™ä¸ªè§„æ ¼çš„é’¢æï¼Œéœ€è¦ä¸ºå®ƒåˆ›å»ºæ‰€æœ‰ç›¸å…³çš„å­˜å‚¨ç©ºé—´ã€‚
    if (!this.remainderPools[groupKey]) {
      // ä¸ºè¿™ä¸ªè§„æ ¼åˆ›å»ºä¸€ä¸ªç©ºçš„ã€å¯ç”¨ä½™æ–™æ± ã€‘æ•°ç»„ã€‚
      this.remainderPools[groupKey] = [];
      // ä¸ºè¿™ä¸ªè§„æ ¼åˆ›å»ºä¸€ä¸ªç©ºçš„ã€ä½¿ç”¨å†å²ã€‘æ•°ç»„ã€‚
      this.usageHistory[groupKey] = [];
      // ã€æ ¸å¿ƒæ–°å¢ã€‘ä¸ºè¿™ä¸ªè§„æ ¼åˆ›å»ºä¸€ä¸ªç©ºçš„ã€åºŸæ–™ä»“ã€‘æ•°ç»„ã€‚
      // è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œç¡®ä¿äº†åºŸæ–™ä»“å’Œä½™æ–™æ± æ˜¯åŒæ­¥åˆ›å»ºçš„ï¼Œé¿å…äº†åç»­æ“ä½œçš„é”™è¯¯ã€‚
      this.wasteBin[groupKey] = [];
      // ä¸ºè¿™ä¸ªè§„æ ¼åˆ›å»ºä¸€ä¸ªç©ºçš„ã€ç¼–å·è®¡æ•°å™¨ã€‘å¯¹è±¡ã€‚
      this.remainderCounters[groupKey] = { letterIndex: 0, numbers: {} };
    }
  }
  // ...
}